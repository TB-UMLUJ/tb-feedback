
-- =========================================================
-- Ù…Ù„Ù Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Supabase (SQL) - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°ÙƒÙŠØ© (ERP Update)
-- =========================================================

-- 1. Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Tables)
-- -------------------

CREATE TABLE IF NOT EXISTS public.maintenance_requests (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ¥Ø¶Ø§ÙØªÙ‡Ø§ (Idempotent)
DO $$
BEGIN
    -- Basic Columns
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'maintenance_requests' AND column_name = 'report_id') THEN
        ALTER TABLE public.maintenance_requests ADD COLUMN report_id text;
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'maintenance_requests' AND column_name = 'name') THEN
        ALTER TABLE public.maintenance_requests ADD COLUMN name text;
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'maintenance_requests' AND column_name = 'category') THEN
        ALTER TABLE public.maintenance_requests ADD COLUMN category text;
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'maintenance_requests' AND column_name = 'location') THEN
        ALTER TABLE public.maintenance_requests ADD COLUMN location text;
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'maintenance_requests' AND column_name = 'details') THEN
        ALTER TABLE public.maintenance_requests ADD COLUMN details text;
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'maintenance_requests' AND column_name = 'image_url') THEN
        ALTER TABLE public.maintenance_requests ADD COLUMN image_url text;
    END IF;

    -- New ERP Columns (Status, Priority, Notes)
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'maintenance_requests' AND column_name = 'status') THEN
        ALTER TABLE public.maintenance_requests ADD COLUMN status text DEFAULT 'new';
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'maintenance_requests' AND column_name = 'priority') THEN
        ALTER TABLE public.maintenance_requests ADD COLUMN priority text DEFAULT 'normal';
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'maintenance_requests' AND column_name = 'internal_notes') THEN
        ALTER TABLE public.maintenance_requests ADD COLUMN internal_notes text;
    END IF;
END $$;

-- Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
CREATE TABLE IF NOT EXISTS public.site_settings (
  id bigint generated by default as identity primary key,
  logo_url text,
  welcome_title text default 'Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ !',
  welcome_body text default 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒÙˆÙ† Ù…Ø³ØªØ¹Ø¯Ø§Ù‹',
  thank_you_title text default 'Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø´Ø§Ø±ÙƒØªÙƒÙ…!',
  thank_you_body text default 'Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒÙ… ØªÙ…Ø«Ù‘Ù„ Ø±ÙƒÙŠØ²Ø© Ø£Ø³Ø§Ø³ÙŠØ© Ù„ØªØ­Ø³ÙŠÙ† Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰'
);

INSERT INTO public.site_settings (logo_url)
SELECT 'https://cdn-icons-png.flaticon.com/512/3063/3063823.png'
WHERE NOT EXISTS (SELECT 1 FROM public.site_settings);

-- 2. Ø³ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† (RLS Policies)
-- -------------------------------

ALTER TABLE public.maintenance_requests ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.site_settings ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Enable insert for everyone" ON public.maintenance_requests;
DROP POLICY IF EXISTS "Enable read for everyone" ON public.maintenance_requests;
DROP POLICY IF EXISTS "Enable update for everyone" ON public.maintenance_requests; 
DROP POLICY IF EXISTS "Enable delete for everyone" ON public.maintenance_requests; -- New line for delete
DROP POLICY IF EXISTS "Enable read settings for everyone" ON public.site_settings;
DROP POLICY IF EXISTS "Enable update settings" ON public.site_settings;

CREATE POLICY "Enable insert for everyone" ON public.maintenance_requests FOR INSERT WITH CHECK (true);
CREATE POLICY "Enable read for everyone" ON public.maintenance_requests FOR SELECT USING (true);
CREATE POLICY "Enable update for everyone" ON public.maintenance_requests FOR UPDATE USING (true);
CREATE POLICY "Enable delete for everyone" ON public.maintenance_requests FOR DELETE USING (true); -- IMPORTANT: This allows deletion
CREATE POLICY "Enable read settings for everyone" ON public.site_settings FOR SELECT USING (true);
CREATE POLICY "Enable update settings" ON public.site_settings FOR UPDATE USING (true);

-- 3. Ø§Ù„ØªØ®Ø²ÙŠÙ†
-- ----------------------------

INSERT INTO storage.buckets (id, name, public)
VALUES ('maintenance-photos', 'maintenance-photos', true)
ON CONFLICT (id) DO NOTHING;

DROP POLICY IF EXISTS "Public Access to Upload Request Images" ON storage.objects;
DROP POLICY IF EXISTS "Public Access to View All Images" ON storage.objects;

CREATE POLICY "Public Access to Upload Request Images" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'maintenance-photos');
CREATE POLICY "Public Access to View All Images" ON storage.objects FOR SELECT USING (true);

-- 4. Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªÙŠÙ„ÙŠÙ‚Ø±Ø§Ù…
-- -------------------------------------------
CREATE EXTENSION IF NOT EXISTS pg_net;

CREATE OR REPLACE FUNCTION public.notify_telegram()
RETURNS trigger AS $$
DECLARE
  bot_token text := '8397226067:AAHAnYgA7cXNkpSf-qjeq-DOODrkIlZ1r5A'; 
  chat_id text := '-1003288534371'; 
  message text;
  api_url text;
BEGIN
  message := E'ğŸš¨ <b>Ø¨Ù„Ø§Øº ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯</b> ğŸš¨\n' ||
             E'#ï¸âƒ£ <b>Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº:</b> <code>' || COALESCE(new.report_id, 'ØºÙŠØ± Ù…ØªÙˆÙØ±') || E'#</code>\n\n' ||
             E'ğŸ‘¤ <b>Ø§Ù„Ø§Ø³Ù…:</b> ' || COALESCE(new.name, '-') || E'\n' ||
             E'ğŸ·ï¸ <b>Ø§Ù„ÙØ¦Ø©:</b> ' || COALESCE(new.category, '-') || E'\n' ||
             E'ğŸ“ <b>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</b> ' || COALESCE(new.location, '-') || E'\n' ||
             E'ğŸ“ <b>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</b> ' || COALESCE(new.details, '-') || E'\n' ||
             E'ğŸ“… <b>Ø§Ù„ØªÙˆÙ‚ÙŠØª:</b> ' || to_char(new.created_at, 'YYYY-MM-DD HH24:MI');

  IF new.image_url IS NOT NULL AND new.image_url != '' THEN
     message := message || E'\n\nğŸ“· <b>ØµÙˆØ±Ø© Ø§Ù„Ø¨Ù„Ø§Øº:</b>\n<a href="' || new.image_url || '">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©</a>';
  END IF;

  api_url := 'https://api.telegram.org/bot' || bot_token || '/sendMessage';

  PERFORM net.http_post(
    url := api_url,
    headers := '{"Content-Type": "application/json"}'::jsonb,
    body := jsonb_build_object(
      'chat_id', chat_id,
      'text', message,
      'parse_mode', 'HTML',
      'disable_web_page_preview', false
    )
  );
  return new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_maintenance_request_created ON public.maintenance_requests;
CREATE TRIGGER on_maintenance_request_created
AFTER INSERT ON public.maintenance_requests
FOR EACH ROW EXECUTE FUNCTION public.notify_telegram();
